{{/*
Copyright (c) 2025 VH & Co BV. Licensed under the Business Source License 1.1.

Auto-generated secrets for zero-config deployment.
When the user does NOT supply an external secretName, the chart creates a Secret
with random credentials. The `lookup` function preserves values across upgrades.

To bring your own secrets, set secrets.<component>.secretName in values.yaml —
the chart will NOT create a Secret for that component.
*/}}

{{/* ── Auto-generated PostgreSQL secret ─────────────────────────────── */}}
{{- if not .Values.secrets.postgresql.secretName }}
{{- $secretName := printf "%s-postgresql" (include "stackweaver.fullname" .) }}
{{- $existing := lookup "v1" "Secret" .Release.Namespace $secretName }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "stackweaver.labels" . | nindent 4 }}
    app.kubernetes.io/component: postgresql
  annotations:
    helm.sh/resource-policy: keep
type: Opaque
data:
  {{- if $existing }}
  {{ .Values.secrets.postgresql.keys.password }}: {{ index $existing.data .Values.secrets.postgresql.keys.password }}
  {{- else }}
  {{ .Values.secrets.postgresql.keys.password }}: {{ randAlphaNum 24 | b64enc }}
  {{- end }}
---
{{- end }}

{{/* ── Auto-generated MinIO secret ──────────────────────────────────── */}}
{{- if not .Values.secrets.minio.secretName }}
{{- $secretName := printf "%s-minio" (include "stackweaver.fullname" .) }}
{{- $existing := lookup "v1" "Secret" .Release.Namespace $secretName }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "stackweaver.labels" . | nindent 4 }}
    app.kubernetes.io/component: minio
  annotations:
    helm.sh/resource-policy: keep
type: Opaque
data:
  {{- if $existing }}
  {{ .Values.secrets.minio.keys.accessKey }}: {{ index $existing.data .Values.secrets.minio.keys.accessKey }}
  {{ .Values.secrets.minio.keys.secretKey }}: {{ index $existing.data .Values.secrets.minio.keys.secretKey }}
  {{- else }}
  {{ .Values.secrets.minio.keys.accessKey }}: {{ "minioadmin" | b64enc }}
  {{ .Values.secrets.minio.keys.secretKey }}: {{ randAlphaNum 32 | b64enc }}
  {{- end }}
---
{{- end }}

{{/* ── Auto-generated encryption key ────────────────────────────────── */}}
{{- if not .Values.secrets.encryption.secretName }}
{{- $secretName := printf "%s-encryption" (include "stackweaver.fullname" .) }}
{{- $existing := lookup "v1" "Secret" .Release.Namespace $secretName }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "stackweaver.labels" . | nindent 4 }}
    app.kubernetes.io/component: encryption
  annotations:
    helm.sh/resource-policy: keep
type: Opaque
data:
  {{- if $existing }}
  {{ .Values.secrets.encryption.keys.key }}: {{ index $existing.data .Values.secrets.encryption.keys.key }}
  {{- else }}
  {{/* 32-byte hex string (64 hex chars) */}}
  {{ .Values.secrets.encryption.keys.key }}: {{ printf "%s%s" (randAlphaNum 32 | sha256sum | trunc 32) (randAlphaNum 32 | sha256sum | trunc 32) | b64enc }}
  {{- end }}
---
{{- end }}

{{/* ── Auto-generated Zitadel secret ────────────────────────────────── */}}
{{- if not .Values.secrets.zitadel.secretName }}
{{- $secretName := printf "%s-zitadel" (include "stackweaver.fullname" .) }}
{{- $existing := lookup "v1" "Secret" .Release.Namespace $secretName }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "stackweaver.labels" . | nindent 4 }}
    app.kubernetes.io/component: zitadel
  annotations:
    helm.sh/resource-policy: keep
type: Opaque
data:
  {{- if $existing }}
  {{ .Values.secrets.zitadel.keys.masterkey }}: {{ index $existing.data .Values.secrets.zitadel.keys.masterkey }}
  {{ .Values.secrets.zitadel.keys.adminPassword }}: {{ index $existing.data .Values.secrets.zitadel.keys.adminPassword }}
  {{- else }}
  {{/* masterkey must be exactly 32 chars */}}
  {{ .Values.secrets.zitadel.keys.masterkey }}: {{ randAlphaNum 32 | b64enc }}
  {{ .Values.secrets.zitadel.keys.adminPassword }}: {{ printf "%s!1A" (randAlphaNum 16) | b64enc }}
  {{- end }}
  {{/* These keys are populated by zitadel-init — start empty */}}
  {{- if $existing }}
  {{ .Values.secrets.zitadel.keys.clientId }}: {{ index $existing.data .Values.secrets.zitadel.keys.clientId | default ("" | b64enc) }}
  {{ .Values.secrets.zitadel.keys.clientSecret }}: {{ index $existing.data .Values.secrets.zitadel.keys.clientSecret | default ("" | b64enc) }}
  {{ .Values.secrets.zitadel.keys.loginServiceUserToken }}: {{ index $existing.data .Values.secrets.zitadel.keys.loginServiceUserToken | default ("" | b64enc) }}
  {{ .Values.secrets.zitadel.keys.frontendClientId }}: {{ index $existing.data .Values.secrets.zitadel.keys.frontendClientId | default ("" | b64enc) }}
  {{ .Values.secrets.zitadel.keys.webhookIdpSyncKey }}: {{ index $existing.data .Values.secrets.zitadel.keys.webhookIdpSyncKey | default ("" | b64enc) }}
  {{ .Values.secrets.zitadel.keys.webhookComplementTokenKey }}: {{ index $existing.data .Values.secrets.zitadel.keys.webhookComplementTokenKey | default ("" | b64enc) }}
  {{- else }}
  {{ .Values.secrets.zitadel.keys.clientId }}: {{ "" | b64enc }}
  {{ .Values.secrets.zitadel.keys.clientSecret }}: {{ "" | b64enc }}
  {{ .Values.secrets.zitadel.keys.loginServiceUserToken }}: {{ "" | b64enc }}
  {{ .Values.secrets.zitadel.keys.frontendClientId }}: {{ "" | b64enc }}
  {{ .Values.secrets.zitadel.keys.webhookIdpSyncKey }}: {{ "" | b64enc }}
  {{ .Values.secrets.zitadel.keys.webhookComplementTokenKey }}: {{ "" | b64enc }}
  {{- end }}
{{- end }}
