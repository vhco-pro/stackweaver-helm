# Copyright (c) 2025 VH & Co BV. Licensed under the Business Source License 1.1. See LICENSE for details.
#
# StackWeaver Helm Chart — values.yaml
# ─────────────────────────────────────
# Override with --set or -f custom-values.yaml at install time.
#
# SECRETS:
#   All secrets must be provided as pre-existing Kubernetes Secrets (via External
#   Secrets Operator, Sealed Secrets, or kubectl create secret). The chart only
#   references them by name — it never creates Secret resources containing
#   user-provided credentials.
#
#   A small number of operational secrets (e.g., OIDC RSA signing key) can be
#   auto-generated by the chart when no external secret is specified.

# ── Global ────────────────────────────────────────────────────────────────────

global:
  imagePullSecrets: []

nameOverride: ""
fullnameOverride: ""

# ── Service Account ───────────────────────────────────────────────────────────

serviceAccount:
  create: true
  name: ""
  annotations: {}

# ── Ingress ───────────────────────────────────────────────────────────────────
#
# Two-domain layout:
#   - app host:  Frontend SPA + API (path-based routing)
#   - auth host: Zitadel OIDC + Login UI (only when zitadel.bundled=true)
#
# The API is routed via /api/v2, /.well-known/terraform.json, /v1/modules, /health.
# Everything else on the app host goes to the frontend.

ingress:
  enabled: true
  className: nginx
  annotations: {}
  tls:
    enabled: true
    secretName: stackweaver-tls
    authSecretName: stackweaver-auth-tls
  hosts:
    app: stackweaver.example.com
    auth: auth.stackweaver.example.com

# ── External Secrets ──────────────────────────────────────────────────────────
#
# For each component, you can either:
#   1. Leave secretName empty → chart auto-generates a Secret with random values
#      (preserved across helm upgrade via lookup). Zero config, works out of the box.
#   2. Set secretName to a pre-existing K8s Secret → chart uses it as-is.
#      Use this for production / GitOps (External Secrets Operator, Sealed Secrets, etc.).
#
# The "keys" mapping tells the chart which key name to read from the Secret.
# Only change these if your external Secret uses different key names.

secrets:
  # PostgreSQL credentials
  # Auto-generates a random 24-char password when secretName is empty.
  postgresql:
    secretName: ""
    keys:
      password: password

  # Redis credentials (optional — only needed if Redis auth is enabled)
  redis:
    secretName: ""
    keys:
      password: password

  # MinIO / S3 credentials
  # Auto-generates access-key ("minioadmin") + random secret-key when empty.
  minio:
    secretName: ""
    keys:
      accessKey: access-key
      secretKey: secret-key

  # Encryption key — 32-byte hex string
  # Auto-generates a random key when secretName is empty.
  # Used by API, runner, and ansible-runner for encrypting variables/credentials.
  encryption:
    secretName: ""
    keys:
      key: encryption-key

  # Zitadel credentials
  # Auto-generates masterkey + admin password when empty.
  # After zitadel-init runs, it populates clientId, clientSecret, etc.
  # For external Zitadel: supply all keys directly.
  zitadel:
    secretName: ""
    keys:
      masterkey: masterkey
      adminPassword: admin-password
      clientId: client-id
      clientSecret: client-secret
      loginServiceUserToken: login-service-user-token
      frontendClientId: frontend-client-id
      webhookIdpSyncKey: webhook-idp-sync-key
      webhookComplementTokenKey: webhook-complement-token-key

  # OIDC workload identity signing key (optional — for Azure OIDC / inventory sync)
  # When secretName is empty, the chart auto-generates an RSA key pair.
  oidc:
    secretName: ""
    keys:
      signingKey: signing-key

  # GitHub App credentials (optional — for GitHub VCS integration)
  githubApp:
    secretName: ""
    keys:
      privateKey: private-key
      webhookSecret: webhook-secret

# ── Core Components ───────────────────────────────────────────────────────────

# -- API (Go backend, port 8022) --
api:
  image:
    repository: ghcr.io/stackweaver/api
    tag: latest
    pullPolicy: IfNotPresent
  replicas: 1
  port: 8022
  corsExtraOrigins: ""
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  # Extra environment variables (map of NAME: value).
  # These are added last and can override any auto-generated env var.
  env: {}
  podAnnotations: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}
  # GitHub App integration (non-secret config)
  githubApp:
    id: ""
    name: ""

# -- Frontend (nginx-served SPA, port 80) --
frontend:
  image:
    repository: ghcr.io/stackweaver/frontend
    tag: latest
    pullPolicy: IfNotPresent
  replicas: 1
  port: 80
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi
  env: {}
  podAnnotations: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}

# -- Orchestrator (background job scheduler) --
orchestrator:
  image:
    repository: ghcr.io/stackweaver/orchestrator
    tag: latest
    pullPolicy: IfNotPresent
  replicas: 1
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  env: {}
  podAnnotations: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}
  githubApp:
    id: ""
    name: ""

# -- Terraform Runner --
runner:
  image:
    repository: ghcr.io/stackweaver/runner
    tag: latest
    pullPolicy: IfNotPresent
  replicas: 1
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: "1"
      memory: 1Gi
  env: {}
  podAnnotations: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}

# -- Ansible Runner --
ansibleRunner:
  image:
    repository: ghcr.io/stackweaver/ansible-runner
    tag: latest
    pullPolicy: IfNotPresent
  replicas: 1
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: "1"
      memory: 1Gi
  env: {}
  podAnnotations: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}

# ── Storage ───────────────────────────────────────────────────────────────────

storage:
  # "minio" or "s3"
  provider: minio
  stateBucket: iac-state
  registryBucket: terraform-registry
  ansibleBucket: ansible-artifacts
  s3:
    region: us-east-1
    endpoint: ""

# ── Runner Workspaces PVC ─────────────────────────────────────────────────────

runnerWorkspaces:
  size: 10Gi
  storageClass: ""
  accessMode: ReadWriteMany

# ── Dependencies ──────────────────────────────────────────────────────────────
#
# For each dependency, set enabled=true to deploy it in-cluster (bundled),
# or enabled=false to use an external instance. When external, configure the
# external.* fields and provide credentials in the secrets section above.

# -- PostgreSQL 17 --
postgresql:
  enabled: true
  image:
    repository: postgres
    tag: "17"
  auth:
    username: iac
    database: iac_platform
  storage:
    size: 10Gi
    storageClass: ""
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  external:
    host: ""
    port: 5432
    username: ""
    database: ""
    sslmode: disable

# -- Redis 7 --
redis:
  enabled: true
  image:
    repository: redis
    tag: 7-alpine
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi
  external:
    host: ""
    port: 6379

# -- MinIO --
minio:
  enabled: true
  image:
    repository: minio/minio
    tag: latest
  storage:
    size: 10Gi
    storageClass: ""
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  consolePort: 9001
  external:
    endpoint: ""
    useSSL: false

# -- Zitadel (OIDC Identity Provider) --
# Zitadel is REQUIRED — the stack cannot function without it.
# Set bundled=true to deploy Zitadel in this chart, or bundled=false to use
# an external Zitadel instance. In both cases, provide credentials in secrets.zitadel.
zitadel:
  bundled: true
  image:
    repository: ghcr.io/zitadel/zitadel
    tag: latest
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  config:
    accessTokenLifetime: 12h
    idTokenLifetime: 12h
    refreshTokenIdleExpiration: 720h    # 30 days
    refreshTokenExpiration: 2160h       # 90 days

  loginUI:
    image:
      repository: ghcr.io/zitadel/zitadel-login
      tag: v4.11.1
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi

  init:
    image:
      repository: ghcr.io/stackweaver/zitadel-init
      tag: latest
    adminUsername: "admin@ZITADEL.localhost"
    resources: {}

  # External Zitadel settings (when bundled=false)
  external:
    # Public issuer URL (e.g. https://auth.example.com)
    issuer: ""
    # In-cluster address for gRPC/HTTP calls (e.g. zitadel.other-namespace.svc:8080)
    internalAddr: ""

# ── OIDC Workload Identity ───────────────────────────────────────────────────

oidc:
  # Issuer URL for OIDC workload identity tokens (non-secret, can be left empty)
  issuerUrl: ""

# ── SSO Configuration ─────────────────────────────────────────────────────────

sso:
  enableOidcTeamSync: false
  oidcRemoveFromNonSsoTeams: false
